services:
  traefik:
    image: traefik:v3
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.insecure=false
      - --certificatesresolvers.myresolver.acme.email=${TRAEFIK_ACME_EMAIL:-technik@imi-frankfurt.de}
      - --certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.myresolver.acme.tlschallenge=true
      - --entryPoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entryPoints.websecure.address=:443
      - --log.level=${TRAEFIK_LOG_LEVEL:-DEBUG}
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
    environment:
      TZ: ${TZ:-Europe/Berlin}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
    networks:
      - traefik-net

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: datenschutzportal-backend
    ports:
      - "8000:8000"
    env_file:
      - ./.env
    environment:
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}
    volumes:
      # Mount for development (optional - comment out for production)
      - ./backend:/app
      # Single source of truth: root .env (mounted into backend container)
      - ./.env:/app/.env:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - datenschutzportal-network
      - traefik-net
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-net
      - "traefik.http.routers.datenschutzportal-backend.rule=Host(`${BACKEND_HOST:-api.ds.niceai.de}`)"
      - traefik.http.routers.datenschutzportal-backend.tls=true
      - traefik.http.routers.datenschutzportal-backend.tls.certresolver=myresolver
      - traefik.http.services.datenschutzportal-backend.loadbalancer.server.port=8000
  
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-https://api.ds.niceai.de/api}
        VITE_API_TOKEN: ${VITE_API_TOKEN:-test-api-token-for-local-development}
    container_name: datenschutzportal-frontend
    ports:
      - "3000:80"
    environment:
      # NOTE: Vite production build reads VITE_* at build-time (args above).
      # Keeping runtime env here doesn't hurt, but won't change the built JS.
      VITE_API_URL: ${VITE_API_URL:-https://api.ds.niceai.de/api}
      VITE_API_TOKEN: ${VITE_API_TOKEN:-test-api-token-for-local-development}
      TZ: ${TZ:-Europe/Berlin}
    depends_on:
      backend:
        condition: service_healthy

    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-net
      - "traefik.http.routers.hessenbox-frontend.rule=Host(`${FRONTEND_HOST:-ds.niceai.de}`)"
      - traefik.http.routers.hessenbox-frontend.tls=true
      - traefik.http.routers.hessenbox-frontend.tls.certresolver=myresolver
      - traefik.http.services.hessenbox-frontend.loadbalancer.server.port=80

    restart: unless-stopped
    networks:
      - datenschutzportal-network
      - traefik-net

networks:
  datenschutzportal-network:
    driver: bridge
  traefik-net:
    name: traefik-net
    external: false

